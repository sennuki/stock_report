---
interface Props {
  chartData: any;
  title?: string;
  id: string;
}

const { chartData, title, id } = Astro.props;
---

<div 
  class="plotly-chart-wrapper my-8" 
  data-chart={JSON.stringify(chartData)}
>
  {title && <h3 class="text-xl font-bold mb-4">{title}</h3>}
  {chartData && !chartData.error ? (
    <div id={id} class="plotly-graph-div w-full min-h-[500px] h-[500px]"></div>
  ) : (
    <div class="flex items-center justify-center min-h-[100px] bg-skin-fill/30 border border-dashed border-skin-line rounded-lg">
      <p class="text-gray-500 italic">{chartData?.error || 'データが利用できません'}</p>
    </div>
  )}
</div>

<script>
  declare const Plotly: any;

  function initPlotlyCharts() {
    const wrappers = document.querySelectorAll('.plotly-chart-wrapper');
    
    wrappers.forEach(wrapper => {
      const container = wrapper.querySelector('.plotly-graph-div') as HTMLElement;
      if (!container || (container as any)._plotly_initialized) return;

      const chartDataStr = (wrapper as HTMLElement).dataset.chart;
      if (!chartDataStr) return;

      const chartData = JSON.parse(chartDataStr);
      if (!chartData || chartData.error) return;

      // IntersectionObserver で画面に近づいたときに描画
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            observer.disconnect();
            // 2フレーム待機してDOMの安定を待つ
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                renderChart(container, chartData);
                (container as any)._plotly_initialized = true;
              });
            });
          }
        });
      }, { rootMargin: '200px' });
      
      observer.observe(container);
    });
  }

  function renderChart(container: HTMLElement, chartData: any) {
    if (typeof Plotly === 'undefined') return;

    const isDark = document.documentElement.classList.contains('dark') || 
                   document.documentElement.getAttribute('data-theme') === 'dark';
    
    // データ側のレイアウトを尊重しつつ、テーマとサイズのみ同期
    const layout = JSON.parse(JSON.stringify(chartData.layout || {}));
    layout.template = isDark ? 'plotly_dark' : 'plotly_white';
    layout.paper_bgcolor = 'rgba(0,0,0,0)';
    layout.plot_bgcolor = 'rgba(0,0,0,0)';
    layout.height = 500; // 高さを固定して座標の圧縮を防ぐ
    layout.autosize = true;

    // 軸やフォントの色のみ微調整
    const grey = isDark ? '#9ca3af' : 'rgba(0, 0, 0, 0.6)';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    const updateAxis = (axisName: string) => {
      if (!layout[axisName]) return;
      layout[axisName].gridcolor = gridColor;
      if (!layout[axisName].tickfont) layout[axisName].tickfont = {};
      layout[axisName].tickfont.color = grey;
      if (layout[axisName].title && typeof layout[axisName].title !== 'string') {
        if (!layout[axisName].title.font) layout[axisName].title.font = {};
        layout[axisName].title.font.color = grey;
      }
    };
    ['xaxis', 'yaxis', 'yaxis2'].forEach(updateAxis);

    // 描画
    Plotly.react(container, chartData.data, layout, {
      displayModeBar: false,
      responsive: true,
      scrollZoom: false
    });
  }

  // ページロードおよび遷移時に実行
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.plotly-graph-div').forEach(el => {
      (el as any)._plotly_initialized = false;
    });
    initPlotlyCharts();
  });

  // テーマ変更時に再描画
  const themeObserver = new MutationObserver(() => {
    document.querySelectorAll('.plotly-graph-div').forEach(container => {
      const wrapper = container.closest('.plotly-chart-wrapper') as HTMLElement;
      if (wrapper && (container as any)._plotly_initialized) {
        const chartData = JSON.parse(wrapper.dataset.chart || '{}');
        renderChart(container as HTMLElement, chartData);
      }
    });
  });
  themeObserver.observe(document.documentElement, { attributes: true });

  // リサイズ対応
  window.addEventListener('resize', () => {
    document.querySelectorAll('.plotly-graph-div').forEach(container => {
      if ((container as any)._plotly_initialized) {
        Plotly.Plots.resize(container);
      }
    });
  });
</script>

<style is:global>
  .plotly-graph-div {
    width: 100%;
    height: 500px !important;
    min-height: 500px !important;
    overflow: visible !important;
  }
</style>
