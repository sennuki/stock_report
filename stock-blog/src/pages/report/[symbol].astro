---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import stocks from "@/data/stocks.json";
import fs from "node:fs";
import path from "node:path";
import PlotlyChart from "@/components/report/PlotlyChart.astro";
import TradingViewWidget from "@/components/report/TradingViewWidget.astro";
import PeerLinks from "@/components/report/PeerLinks.astro";

export async function getStaticPaths() {
  // Use stocks.json as the source of truth for symbols
  return (stocks as any[]).map((stock: any) => ({
    params: { symbol: stock.Symbol_YF },
  }));
}

const { symbol } = Astro.params;
const jsonPath = path.join(process.cwd(), "public", "reports", `${symbol}.json`);

let reportData: any = null;
let lastUpdated: string = "";

if (fs.existsSync(jsonPath)) {
  const stats = fs.statSync(jsonPath);
  lastUpdated = new Intl.DateTimeFormat("ja-JP", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(stats.mtime);

  const content = fs.readFileSync(jsonPath, "utf-8");
  reportData = JSON.parse(content);
}

const stockInfo = (stocks as any[]).find((s: any) => s.Symbol_YF === symbol);
const title = `${symbol} (${stockInfo?.Security || ''}) éŠ˜æŸ„åˆ†æï¼šæ ªä¾¡ãƒ»PERãƒ»é…å½“åˆ©å›ã‚Šãƒ»ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ`;
const description = `${symbol} (${stockInfo?.Security || ''}) ã®æœ€æ–°æ ªä¾¡ã€PERã€é…å½“åˆ©å›ã‚Šã€è²¡å‹™æ¨ç§»ãªã©ã®ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¶²ç¾…ã€‚æŠ•è³‡åˆ¤æ–­ã«å½¹ç«‹ã¤åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’å®šæœŸçš„ã«æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚`;

const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

// Calculate Analyst Summary in frontmatter to avoid template parsing issues with "<"
let analystSummary = null;
if (reportData?.analyst_ratings) {
  const r = reportData.analyst_ratings;
  const total = (r.strongBuy || 0) + (r.buy || 0) + (r.hold || 0) + (r.sell || 0) + (r.strongSell || 0);
  const score = total > 0 
    ? ((r.strongBuy || 0) * 1 + (r.buy || 0) * 2 + (r.hold || 0) * 3 + (r.sell || 0) * 4 + (r.strongSell || 0) * 5) / total 
    : 0;
  
  let assessment = "ä¸æ˜";
  let assessmentColor = "text-gray-500";
  if (score > 0 && score <= 1.5) { assessment = "å¼·æ°—è²·ã„ (Strong Buy)"; assessmentColor = "text-green-600"; }
  else if (score > 1.5 && score <= 2.5) { assessment = "è²·ã„ (Buy)"; assessmentColor = "text-green-500"; }
  else if (score > 2.5 && score <= 3.5) { assessment = "ä¸­ç«‹ (Hold)"; assessmentColor = "text-gray-500"; }
  else if (score > 3.5 && score <= 4.5) { assessment = "å£²ã‚Š (Sell)"; assessmentColor = "text-red-500"; }
  else if (score > 4.5) { assessment = "å¼·ã„å£²ã‚Š (Strong Sell)"; assessmentColor = "text-red-700"; }

  analystSummary = { total, score, assessment, assessmentColor, ratings: r };
}
---

<Layout title={title} description={description}>
  <Header />
  
  <main id="main-content" class="w-full px-4 py-8 max-w-app mx-auto">
    <div class="mb-6">
       <a href={base} class="text-skin-accent hover:underline inline-flex items-center">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
         </svg>
         éŠ˜æŸ„ä¸€è¦§ã«æˆ»ã‚‹
       </a>
    </div>

    {!reportData ? (
      <div class="report-content bg-skin-card p-10 rounded-lg border border-skin-line shadow-sm text-center">
        <p class="text-xl">ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {symbol}</p>
        <p class="mt-4 text-gray-500">ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    ) : (
      <div class="report-content bg-skin-card p-4 sm:p-8 rounded-lg border border-skin-line shadow-sm">
        <h1 class="text-3xl font-bold mb-2">éŠ˜æŸ„åˆ†æãƒ¬ãƒãƒ¼ãƒˆ: {reportData.symbol} ({reportData.security})</h1>
        {lastUpdated && (
          <div class="flex items-center text-sm text-gray-500 mb-6 bg-skin-fill/30 px-3 py-1.5 rounded-md border border-skin-line w-fit">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-skin-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>æœ€çµ‚æ›´æ–°æ—¥: {lastUpdated} <span class="mx-2 text-skin-line">|</span> ç±³å›½å¸‚å ´é–‰å ´å¾Œã€å…¨éŠ˜æŸ„ã‚’æ¯æ—¥è‡ªå‹•æ›´æ–°</span>
          </div>
        )}

            <TradingViewWidget symbol={reportData.full_symbol} type="symbol-info" />

        <hr class="my-8 border-skin-line" />

        <nav class="toc bg-skin-fill/50 p-6 rounded-lg border border-skin-line mb-10">
            <h3 class="text-lg font-bold mb-4">ç›®æ¬¡</h3>
            <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 list-disc pl-5">
                <li><a href="#stock-chart" class="text-skin-accent hover:underline">{symbol}ã®æ ªä¾¡æ¨ç§»ãƒ»æ¦‚è¦</a></li>
                <li><a href="#valuation" class="text-skin-accent hover:underline">{symbol}ã®éå»PERæ¯”è¼ƒ</a></li>
                <li><a href="#risk-return" class="text-skin-accent hover:underline">{symbol}ã®ãƒªã‚¹ã‚¯ãƒ»ãƒªã‚¿ãƒ¼ãƒ³åˆ†æ</a></li>
                <li><a href="#peers" class="text-skin-accent hover:underline">{symbol}ã®åŒæ¥­ç¨®ãƒ»ç«¶åˆ</a></li>
                <li><a href="#sector-peers" class="text-skin-accent hover:underline">{symbol}ã®åŒã‚»ã‚¯ã‚¿ãƒ¼ä»–ç¤¾</a></li>
                <li><a href="#performance" class="text-skin-accent hover:underline">{symbol}ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</a></li>
                <li><a href="#fundamentals" class="text-skin-accent hover:underline">{symbol}ã®ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚ºåˆ†æ (æ¦‚è¦)</a></li>
                <li><a href="#fundamentals-detail" class="text-skin-accent hover:underline">{symbol}ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ¨ç§» (è©³ç´°)</a>
                    <ul class="pl-5 mt-1 text-sm list-circle">
                        <li><a href="#balance-sheet" class="text-skin-accent hover:underline">è²¸å€Ÿå¯¾ç…§è¡¨</a></li>
                        <li><a href="#income-statement" class="text-skin-accent hover:underline">æç›Šè¨ˆç®—æ›¸</a></li>
                        <li><a href="#cash-flow" class="text-skin-accent hover:underline">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼</a></li>
                        <li><a href="#shareholder-return" class="text-skin-accent hover:underline">æ ªä¸»é‚„å…ƒ</a></li>
                        <li><a href="#dividend-history" class="text-skin-accent hover:underline">1æ ªã‚ãŸã‚Šé…å½“é‡‘</a></li>
                    </ul>
                </li>
                <li><a href="#analyst-ratings" class="text-skin-accent hover:underline">{symbol}ã®ã‚¢ãƒŠãƒªã‚¹ãƒˆè©•ä¾¡ (ç›´è¿‘)</a></li>
            </ul>
        </nav>

        <section id="stock-chart">
          <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ“ˆ {symbol}ã®æ ªä¾¡æ¨ç§»ãƒ»æ¦‚è¦</h2>
                <TradingViewWidget symbol={reportData.full_symbol} type="symbol-overview" height={650} />
        </section>

        {reportData.charts.pe_valuation && (
          <section id="valuation" class="mt-12 bg-skin-fill/10 p-6 rounded-lg border border-skin-line">
            <h2 class="text-xl font-bold mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-skin-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              éå»5å¹´é–“ã®PERæ°´æº–ã¨ã®æ¯”è¼ƒ
            </h2>
            <div class="mb-2">
              <PlotlyChart chartData={reportData.charts.pe_valuation} id="chart-pe-valuation" />
            </div>
            <p class="text-sm text-gray-500 text-center">
              {reportData.valuation.current < reportData.valuation.median 
                ? "ç¾åœ¨ã®PERã¯éå»5å¹´é–“ã®ä¸­å¤®å€¤ã‚ˆã‚Šã‚‚ä½ãã€æ­´å²çš„ã«è¦‹ã¦å‰²å®‰ãªæ°´æº–ã«ã‚ã‚Šã¾ã™ã€‚" 
                : "ç¾åœ¨ã®PERã¯éå»5å¹´é–“ã®ä¸­å¤®å€¤ã‚ˆã‚Šã‚‚é«˜ãã€æ­´å²çš„ã«è¦‹ã¦å‰²é«˜ãªæ°´æº–ã«ã‚ã‚Šã¾ã™ã€‚"}
            </p>
          </section>
        )}

        <section id="risk-return" class="mt-12">
          <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ¯ {symbol}ã®ãƒªã‚¹ã‚¯ãƒ»ãƒªã‚¿ãƒ¼ãƒ³åˆ†æ</h2>
          <p class="mb-4">
            <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1"></span> <strong>{reportData.symbol}</strong> (å¯¾è±¡) vs 
            <span class="inline-block w-3 h-3 bg-blue-500 transform rotate-45 mr-1"></span> <strong>{reportData.sector_etf}</strong> (ã‚»ã‚¯ã‚¿ãƒ¼) vs 
            <span class="inline-block w-3 h-3 bg-black rounded-sm mr-1"></span> â˜… <strong>S&P 500</strong>
          </p>
          <PlotlyChart chartData={reportData.charts.risk_return} id="chart-risk-return" />
        </section>

        <section id="peers" class="mt-12">
          <PeerLinks title={`ğŸ¢ ${symbol}ã®åŒæ¥­ç¨®ãƒ»ç«¶åˆ (${reportData.sub_industry})`} peers={reportData.peers.sub_industry} />
        </section>

        <section id="sector-peers">
          <PeerLinks title={`ğŸ­ ${symbol}ã®åŒã‚»ã‚¯ã‚¿ãƒ¼ä»–ç¤¾ (${reportData.sector})`} peers={reportData.peers.sector} collapsible={true} />
        </section>

        <hr class="my-12 border-skin-line" />

        <section id="performance">
          <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ“ˆ {symbol}ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</h2>
          <TradingViewWidget 
            symbol={reportData.full_symbol} 
            type="advanced-chart" 
            height={600} 
            compareSymbols={[
              { symbol: `AMEX:${reportData.sector_etf}`, position: "SameScale" },
              { symbol: "FRED:SP500", position: "SameScale" }
            ]}
          />
        </section>

        <section id="fundamentals" class="mt-12">
          <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ“Š {symbol}ã®ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚ºåˆ†æ</h2>
          <TradingViewWidget symbol={reportData.full_symbol} type="financials" height={950} />
        </section>

        <section id="fundamentals-detail" class="mt-12">
          <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ“ˆ {symbol}ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ¨ç§» (è©³ç´°åˆ†æ)</h2>
          
          <div id="balance-sheet" class="scroll-mt-20">
            <PlotlyChart chartData={reportData.charts.bs} id="chart-bs" title="è²¸å€Ÿå¯¾ç…§è¡¨" />
          </div>
          
          <div id="income-statement" class="scroll-mt-20">
            <PlotlyChart chartData={reportData.charts.is} id="chart-is" title="æç›Šè¨ˆç®—æ›¸" />
          </div>
          
          <div id="cash-flow" class="scroll-mt-20">
            <PlotlyChart chartData={reportData.charts.cf} id="chart-cf" title="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼" />
          </div>
          
          <div id="shareholder-return" class="scroll-mt-20">
            <PlotlyChart chartData={reportData.charts.tp} id="chart-tp" title="æ ªä¸»é‚„å…ƒ" />
          </div>
          
          <div id="dividend-history" class="scroll-mt-20">
            <PlotlyChart chartData={reportData.charts.dps} id="chart-dps" title="1æ ªã‚ãŸã‚Šé…å½“é‡‘" />
            <p class="text-sm text-gray-500 mt-2">â€»é…å½“å›æ•°ã‚’æ¨å®šã—ã¦å¹´æ›ç®—åˆ©å›ã‚Šã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
          </div>
        </section>

        <hr class="my-12 border-skin-line" />

        <section id="analyst-ratings" class="mt-12">
          <h2 class="text-2xl font-bold mb-6 border-b pb-2">ğŸ¯ {symbol}ã®ã‚¢ãƒŠãƒªã‚¹ãƒˆè©•ä¾¡ (ç›´è¿‘)</h2>
          {analystSummary ? (
            <div class="space-y-8">
              {/* Summary Card */}
              <div class="bg-skin-fill/20 p-6 rounded-lg border border-skin-line flex flex-col sm:flex-row justify-around items-center text-center gap-6">
                <div>
                  <div class="text-sm opacity-70 mb-1">ç·åˆè©•ä¾¡</div>
                  <div class={`text-2xl font-bold ${analystSummary.assessmentColor}`}>{analystSummary.assessment}</div>
                </div>
                <div class="w-px h-10 bg-skin-line hidden sm:block"></div>
                <div>
                  <div class="text-sm opacity-70 mb-1">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                  <div class="text-2xl font-bold text-skin-base">{analystSummary.score.toFixed(2)} <span class="text-sm font-normal opacity-50">/ 5.0</span></div>
                </div>
                <div class="w-px h-10 bg-skin-line hidden sm:block"></div>
                <div>
                  <div class="text-sm opacity-70 mb-1">ã‚¢ãƒŠãƒªã‚¹ãƒˆæ•°</div>
                  <div class="text-2xl font-bold text-skin-base">{analystSummary.total}äºº</div>
                </div>
              </div>

              <div class="space-y-6">
                {[
                  { label: "å¼·æ°—è²·ã„ (Strong Buy)", key: "strongBuy", color: "text-green-600" },
                  { label: "è²·ã„ (Buy)", key: "buy", color: "text-green-500" },
                  { label: "ä¸­ç«‹ (Hold)", key: "hold", color: "text-gray-500" },
                  { label: "å£²ã‚Š (Sell)", key: "sell", color: "text-red-500" },
                  { label: "å¼·ã„å£²ã‚Š (Strong Sell)", key: "strongSell", color: "text-red-700" }
                ].map((rating) => (
                  <div class="rating-row">
                    <div class="flex justify-between items-center mb-2">
                      <span class={`font-bold ${rating.color}`}>{rating.label}</span>
                      <span class="text-sm font-medium">{analystSummary.ratings[rating.key] || 0}äºº</span>
                    </div>
                    <div class="flex flex-wrap gap-0.5 text-lg leading-none opacity-80">
                      {Array.from({ length: analystSummary.ratings[rating.key] || 0 }).map(() => (
                        <span title={rating.label}>ğŸ‘¤</span>
                      ))}
                      {(!analystSummary.ratings[rating.key] || analystSummary.ratings[rating.key] === 0) && (
                        <span class="text-gray-300 text-sm italic">è©²å½“ãªã—</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              <p class="text-xs text-gray-400 mt-8">
                â€»å¹³å‡ã‚¹ã‚³ã‚¢ã¯ 1.0(å¼·æ°—è²·ã„)ã‹ã‚‰5.0(å¼·ã„å£²ã‚Š)ã®ç¯„å›²ã§ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚<br />
                â€»ã‚¢ãƒŠãƒªã‚¹ãƒˆã®æ¨å¥¨è©•ä¾¡ã®åˆè¨ˆäººæ•°ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚æŠ•è³‡ã®æœ€çµ‚åˆ¤æ–­ã¯ã”è‡ªèº«ã§è¡Œã£ã¦ãã ã•ã„ã€‚
              </p>
            </div>
          ) : (
            <p class="text-gray-500">ã‚¢ãƒŠãƒªã‚¹ãƒˆè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
          )}
        </section>
      </div>
    )}
  </main>
  <Footer />
</Layout>

<style>
  .report-content {
    color: var(--color-text-base);
  }
  .report-content h2 {
    margin-top: 2.5rem;
    color: var(--color-text-base);
  }
  .scroll-mt-20 {
    scroll-margin-top: 5rem;
  }
  .list-circle {
    list-style-type: circle;
  }
</style>
