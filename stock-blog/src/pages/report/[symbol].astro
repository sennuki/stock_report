---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import stocks from "@/data/stocks.json";
import fs from "node:fs";
import path from "node:path";

export async function getStaticPaths() {
  const blogDir = path.join(process.cwd(), "src", "data", "blog");
  if (fs.existsSync(blogDir)) {
    const files = fs.readdirSync(blogDir);
    return files
      .filter(file => file.endsWith(".md"))
      .map(file => ({
        params: { symbol: file.replace(".md", "") },
      }));
  }
  return [];
}

const { symbol } = Astro.params;
const filePath = path.join(process.cwd(), "public", "output_reports_full", `${symbol}.html`);

let headContent = "";
let bodyContent = "";

try {
  if (fs.existsSync(filePath)) {
    const htmlContent = fs.readFileSync(filePath, "utf-8");
    
    const headMatch = htmlContent.match(/<head[^>]*>([\s\S]*?)<\/head>/i);
    const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    
    if (headMatch) {
       headContent = headMatch[1]
         .replace(/<title>.*?<\/title>/i, "")
         .replace(/<meta charset.*?>/i, "")
         .replace(/<meta name="viewport".*?>/i, "")
         // Remove body/html style to prevent breaking layout
         .replace(/(body|html)[^\{]*\{[^\}]*\}/gi, ""); 
    }
    
    if (bodyMatch) {
      bodyContent = bodyMatch[1];
    }
  } else {
    bodyContent = `<div class="text-center py-10">Report not found for ${symbol}</div>`;
  }
} catch (e) {
  console.error(e);
  bodyContent = `<div class="text-center py-10">Error loading report for ${symbol}</div>`;
}

const stockInfo = (stocks as any[]).find((s: any) => s.Symbol_YF === symbol);
const title = `銘柄分析: ${symbol} - ${stockInfo?.Security || ''}`;

const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
---

<Layout title={title}>
  <Header />
  
  {/* Load Plotly.js from CDN */}
  <script is:inline src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>

  {/* Inject extracted scripts and styles. */}
  <div id="report-head-injection">
      <Fragment set:html={headContent} />
  </div>

  <main id="main-content" class="w-full px-4 py-8 max-w-app mx-auto">
    <div class="mb-6">
       <a href={base} class="text-skin-accent hover:underline inline-flex items-center">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
         </svg>
         銘柄一覧に戻る
       </a>
    </div>

    <div class="report-content bg-skin-card p-6 rounded-lg border border-skin-line shadow-sm">
      <Fragment set:html={bodyContent} />
    </div>
  </main>
  <Footer />
</Layout>

<script>
  // Function to manually execute scripts inserted via innerHTML
  async function executeScripts(container: Element | null) {
    if (!container) return;
    const isDark = document.documentElement.classList.contains('dark');
    const scripts = Array.from(container.querySelectorAll('script'));
    
    for (const oldScript of scripts) {
      const newScript = document.createElement('script');
      
      // Copy attributes
      Array.from(oldScript.attributes).forEach((attr: Attr) => {
        newScript.setAttribute(attr.name, attr.value);
      });
      
      // Copy text content (Important for TradingView JSON config)
      let content = oldScript.textContent || '';
      if (isDark) {
        content = content.replace(/"colorTheme":\s*"light"/g, '"colorTheme": "dark"');
        content = content.replace(/"theme":\s*"light"/g, '"theme": "dark"');
      } else {
        content = content.replace(/"colorTheme":\s*"dark"/g, '"colorTheme": "light"');
        content = content.replace(/"theme":\s*"dark"/g, '"theme": "light"');
      }
      newScript.textContent = content;
      
      if (oldScript.src) {
        // External scripts (like TradingView's embed-widget-financials.js)
        newScript.src = oldScript.src;
        newScript.async = true;
        
        const promise = new Promise((resolve) => {
          newScript.onload = resolve;
          newScript.onerror = resolve;
          setTimeout(resolve, 3000); // Safety timeout
        });
        
        if (oldScript.parentNode) {
          oldScript.parentNode.replaceChild(newScript, oldScript);
        }
        await promise;
      } else {
        // Purely inline scripts
        if (oldScript.parentNode) {
          oldScript.parentNode.replaceChild(newScript, oldScript);
        }
      }
    }
  }

  // Function to update Plotly themes dynamically
  function updatePlotlyTheme() {
    // @ts-ignore
    if (!window.Plotly) return;

    const isDark = document.documentElement.classList.contains('dark');
    const theme = isDark ? 'plotly_dark' : 'plotly_white';
    const paper_bgcolor = isDark ? 'rgba(0,0,0,0)' : '#fff';
    const plot_bgcolor = isDark ? 'rgba(0,0,0,0)' : '#fff';
    const font_color = isDark ? '#d1d5db' : '#374151';

    const plots = document.querySelectorAll('.js-plotly-plot');
    plots.forEach(plot => {
      try {
        // @ts-ignore
        window.Plotly.relayout(plot, { 
          template: theme,
          paper_bgcolor: paper_bgcolor,
          plot_bgcolor: plot_bgcolor,
          'font.color': font_color
        });
      } catch (e) {}
    });
  }

  // Main initialization
  async function initPage() {
    // 0. Preliminary cleanup for TradingView widgets to prevent "AAPL default" glitch
    document.querySelectorAll('.tradingview-widget-container__widget').forEach(el => {
        el.innerHTML = '';
    });

    // 1. Ensure Plotly is available
    // @ts-ignore
    if (!window.Plotly) {
      await new Promise(resolve => {
        const check = () => {
          // @ts-ignore
          if (window.Plotly) resolve();
          else setTimeout(check, 100);
        };
        check();
      });
    }

    // 2. Execute scripts in order
    // We wait a tiny bit to ensure DOM is fully ready for TradingView's observer
    const headInjection = document.getElementById('report-head-injection');
    await executeScripts(headInjection);
    
    const reportContent = document.querySelector('.report-content');
    await executeScripts(reportContent);
    
    // 3. Final layout fix and force TradingView re-scan
    requestAnimationFrame(() => {
      updatePlotlyTheme();
      window.dispatchEvent(new Event('resize'));
      
      // Some TradingView widgets need a push after DOM insertion
      // @ts-ignore
      if (window.TradingView && window.TradingView.widget) {
          // This is a generic way to trigger TV widget updates if they are already in the DOM
      }
    });
  }

  document.addEventListener('astro:page-load', initPage);

  // Watch for theme changes (AstroPaper specific)
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        // When theme changes, we might need to re-execute TradingView (heavy) 
        // or just update Plotly (lighter)
        updatePlotlyTheme();
        
        // For TradingView, since they don't support dynamic theme switching easily,
        // we re-run the script execution if the theme class changed significantly
        const reportContent = document.querySelector('.report-content');
        if (reportContent) {
            // Option: Only re-run if needed, but for now just update Plotly
        }
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });

  // Force Plotly resize if present
  window.addEventListener('resize', () => {
    const plots = document.querySelectorAll('.js-plotly-plot');
    plots.forEach(plot => {
      // @ts-ignore
      if (window.Plotly) window.Plotly.Plots.resize(plot);
    });
  });
</script>

<style is:global>
  /* Style overrides for the injected report content */
  .report-content {
    overflow-x: hidden; /* Prevent horizontal scroll on body */
    width: 100%;
    word-break: break-word;
  }
  
  /* Allow text and containers to expand fully but respect parent width */
  .report-content > *,
  .report-content div,
  .report-content p,
  .report-content h1,
  .report-content h2,
  .report-content h3,
  .report-content ul,
  .report-content ol {
    max-width: 100% !important;
    box-sizing: border-box;
  }

  .report-content h1, 
  .report-content h2, 
  .report-content h3, 
  .report-content p, 
  .report-content li,
  .report-content span {
    color: currentColor;
  }

  .report-content h1 {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 1.5rem;
  }
  
  .report-content h2 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 2rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid rgb(var(--color-border));
    padding-bottom: 0.5rem;
  }

  /* Only constrain media and specific embeds to prevent overflow */
  .report-content iframe,
  .report-content table,
  .report-content img,
  .report-content svg {
    max-width: 100% !important;
    height: auto;
  }

  /* Specific handling for TradingView widgets on mobile */
  .tradingview-widget-container {
    width: 100% !important;
    margin-bottom: 20px;
    overflow: hidden;
  }

  /* Ensure plotly graphs fit and are responsive */
  .plotly-graph-div {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
  }
  
  .js-plotly-plot .plotly,
  .js-plotly-plot .plotly div {
    direction: ltr !important;
    width: 100% !important;
  }
</style>
