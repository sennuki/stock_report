---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";

const title = "TradingView Widget Test Page";
---

<Layout title={title}>
  <Header />
  
  <main class="w-full px-4 py-8 max-w-app mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-skin-base">Widget Height Test (450px)</h1>
    
    <div class="report-content bg-skin-card p-6 rounded-lg border border-skin-line shadow-sm">
      <h2 class="text-xl font-bold mb-4 border-bottom pb-2">Symbol Overview Widget</h2>
      
      <div id="test-widget-container" class="tradingview-widget-container mb-8" style="height: 450px; border: 2px dashed #ccc;">
        <div class="tradingview-widget-container__widget" style="height: 450px !important; width: 100%;"></div>
        <div class="tradingview-widget-copyright">
          <a href="https://jp.tradingview.com/" rel="noopener nofollow" target="_blank">
            <span class="blue-text">TradingViewで全市場を追跡</span>
          </a>
        </div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
        {
          "symbols": [
            [
              "Apple Inc.",
              "NASDAQ:AAPL|1D"
            ]
          ],
          "chartOnly": false,
          "width": "100%",
          "height": 450,
          "locale": "ja",
          "colorTheme": "light",
          "autosize": false,
          "showVolume": false,
          "showMA": false,
          "hideDateRanges": false,
          "hideMarketStatus": false,
          "hideSymbolLogo": false,
          "scalePosition": "right",
          "scaleMode": "Normal",
          "fontFamily": "-apple-system, BlinkMacSystemFont, Trebuchet MS, Roboto, Ubuntu, sans-serif",
          "fontSize": "10",
          "noTimeScale": false,
          "valuesTracking": "1",
          "changeMode": "price-and-percent",
          "chartType": "area",
          "lineWidth": 2,
          "lineType": 0,
          "dateRanges": [
            "1d|1",
            "1m|30",
            "3m|60",
            "12m|1D",
            "60m|1W",
            "all|1M"
          ]
        }
        </script>
      </div>
    </div>
  </main>
  
  <Footer />
</Layout>

<script>
  async function initWidget() {
    const container = document.getElementById('test-widget-container');
    if (!container) return;

    const oldScript = container.querySelector('script');
    if (!oldScript) return;

    const widgetEl = container.querySelector('.tradingview-widget-container__widget');
    if (widgetEl) widgetEl.innerHTML = '';

    const newScript = document.createElement('script');
    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
    newScript.textContent = oldScript.textContent;
    
    oldScript.parentNode?.replaceChild(newScript, oldScript);
  }

  document.addEventListener('astro:page-load', initWidget);
</script>

<style is:global>
  .tradingview-widget-container {
    width: 100% !important;
  }
  .tradingview-widget-container iframe {
    height: 450px !important;
    min-height: 450px !important;
  }
</style>
